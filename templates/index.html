<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расшифровщик встреч из tl;dv</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent: #4a90e2;
            --accent-hover: #357abd;
            --border: #ddd;
            --success: #4caf50;
            --error: #f44336;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent: #5a9fd4;
            --accent-hover: #4a8fc4;
            --border: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 100%;
            margin: 0 auto;
            width: 100%;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {background: var(--bg-tertiary);
        }

        .input-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .input-method {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }

        .input-method label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .input-method input[type="radio"] {
            margin-right: 8px;
        }

        .html-input-container {
            display: none;
            margin-bottom: 15px;
        }

        .html-input {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .html-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .file-input-container {
            display: none;
            margin-bottom: 15px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .file-input-label.has-file {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            fill: var(--text-secondary);
        }

        .process-btn {
            width: 100%;
            padding: 12px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .process-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .process-btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-actions {
            display: flex;
            gap: 10px;
        }

        .result-header h2 {
            font-size: 18px;
            font-weight: 500;
        }

        .copy-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .copy-btn:hover {
            background: var(--accent);
            color: white;
        }

        .copy-btn.success {
            background: var(--success);
            color: white;
        }

        .result-content {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
            user-select: text;
        }

        .footer {
            text-align: center;
            padding: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid var(--bg-tertiary);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        /* Стили для модального окна */
        .help-btn {
            position: absolute;
            top: 20px;
            right: 80px; /* Сдвигаем левее кнопки темы */
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .help-btn:hover {
            transform: scale(1.1);
            background: var(--bg-tertiary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, backdrop-filter 0.3s ease;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }

        .instruction-list {
            list-style-position: inside;
            padding-left: 0;
        }

        .instruction-list li {
            margin-bottom: 20px;
        }
        .instruction-list p {
            margin-top: 8px;
            margin-left: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        .instruction-list img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            margin-left: 20px;
            border: 1px solid var(--border);
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">🌙</span>
    </button>
    <button class="help-btn" id="help-btn">?</button>

    <div class="container">
        <div class="header">
            <h1>Расшифровщик встреч из tl;dv</h1>
        </div>

        <div class="input-section">
            <div class="input-method">
                <label>
                    <input type="radio" name="input-type" value="text" checked onchange="toggleInputMethod()">
                    Вставить HTML-код
                </label>
                <label>
                    <input type="radio" name="input-type" value="file" onchange="toggleInputMethod()">
                    Загрузить файл
                </label>
            </div>

            <div class="error-message" id="error-message"></div>

            <div class="html-input-container" id="html-input-container">
                <textarea class="html-input" id="html-input" placeholder="Вставьте HTML-код здесь..."></textarea>
            </div>

            <div class="file-input-container" id="file-input-container">
                <div class="file-input-wrapper">
                    <input type="file" class="file-input" id="file-input" accept=".txt,.html,.doc,.docx,.md">
                    <label for="file-input" class="file-input-label" id="file-label">
                        <svg class="file-icon" viewBox="0 0 24 24">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                        <span id="file-label-text">Нажмите для выбора файла или перетащите сюда</span>
                    </label>
                </div>
            </div>

            <button class="process-btn" id="process-btn" onclick="processData()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M9 3L5 6.99h3V14h2V6.99h3L9 3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99h-3z"/>
                </svg>
                Обработать
            </button>
        </div>

        <div class="result-section">
            <div class="result-header">
                <h2>Результат</h2>
                <div class="result-actions">
                    <button class="copy-btn" id="copy-btn" onclick="copyResult()" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        <span id="copy-btn-text">Копировать</span>
                    </button>
                    <button class="copy-btn" id="download-btn" onclick="downloadResult()" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        <span>Скачать .txt</span>
                    </button>
                </div>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">Обработка...</p>
            </div>
            <div class="result-content" id="result-content">
                Результат обработки появится здесь
            </div>
        </div>
    </div>

    <div class="footer">
        <span>Разработал: Пронин Александр</span>
        <a href="https://t.me/Goryuchnik" target="_blank">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.56c-.21 2.27-1.13 7.76-1.6 10.3-.2 1.08-.59 1.44-.97 1.47-.82.07-1.44-.54-2.24-.97-1.24-.84-1.94-1.36-3.14-2.18-1.39-.95-.49-1.47.3-2.32.21-.22 3.82-3.5 3.89-3.8.01-.04.01-.17-.06-.25s-.19-.05-.27-.03c-.12.03-1.99 1.27-5.62 3.72-.53.36-1.01.54-1.44.53-.47-.01-1.38-.27-2.06-.49-.83-.27-1.49-.42-1.43-.88.03-.24.38-.49 1.04-.75 3.84-1.67 6.4-2.77 7.68-3.3 3.66-1.52 4.42-1.78 4.91-1.79.11 0 .35.02.51.12.13.08.17.19.19.31-.01.06.01.24 0 .38z"/>
            </svg>
            Telegram
        </a>
    </div>

    <script>
        // Инициализация темы: светлая по умолчанию, если не сохранено другое
        const savedTheme = localStorage.getItem('theme');
        // Если тема не сохранена (savedTheme === null), устанавливаем 'light', иначе используем сохраненную
        const initialTheme = savedTheme === null ? 'light' : savedTheme;
        document.documentElement.setAttribute('data-theme', initialTheme);
        updateThemeIcon();

        // Показать нужный метод ввода при загрузке
        toggleInputMethod();

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const theme = document.documentElement.getAttribute('data-theme');
            document.getElementById('theme-icon').textContent = theme === 'light' ? '🌙' : '☀️';
        }

        function toggleInputMethod() {
            const inputType = document.querySelector('input[name="input-type"]:checked').value;
            const htmlContainer = document.getElementById('html-input-container');
            const fileContainer = document.getElementById('file-input-container');

            if (inputType === 'text') {
                htmlContainer.style.display = 'block';
                fileContainer.style.display = 'none';
            } else {
                htmlContainer.style.display = 'none';
                fileContainer.style.display = 'block';
            }
        }

        // Обработка файла
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const label = document.getElementById('file-label');
            const labelText = document.getElementById('file-label-text');

            if (file) {
                label.classList.add('has-file');
                labelText.textContent = `Выбран файл: ${file.name}`;
            } else {
                label.classList.remove('has-file');
                labelText.textContent = 'Нажмите для выбора файла или перетащите сюда';
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function processData() {
            const inputType = document.querySelector('input[name="input-type"]:checked').value;
            const formData = new FormData();

            if (inputType === 'text') {
                const htmlText = document.getElementById('html-input').value;
                if (!htmlText.trim()) {
                    showError('Пожалуйста, вставьте HTML-код');
                    return;
                }
                // Создаем Blob из текста, чтобы отправить его как файл и обойти ошибку 413
                const textBlob = new Blob([htmlText], { type: 'text/html' });
                formData.append('file', textBlob, 'pasted_text.html');
            } else {
                const fileInput = document.getElementById('file-input');
                if (!fileInput.files[0]) {
                    showError('Пожалуйста, выберите файл');
                    return;
                }
                formData.append('file', fileInput.files[0]);
            }

            // Показываем загрузку
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result-content').style.display = 'none';
            document.getElementById('process-btn').disabled = true;

            fetch('/process', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('result-content').style.display = 'block';

                if (data.error) {
                    showError(data.error);
                    document.getElementById('result-content').textContent = 'Ошибка обработки';
                } else {
                    document.getElementById('result-content').textContent = data.result;
                    document.getElementById('copy-btn').style.display = 'flex';
                    document.getElementById('download-btn').style.display = 'flex';
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('result-content').style.display = 'block';
                showError('Произошла ошибка при обработке');
                console.error('Error:', error);
            })
            .finally(() => {
                document.getElementById('process-btn').disabled = false;
            });
        }

        function downloadResult() {
            const resultText = document.getElementById('result-content').textContent;
            if (!resultText || resultText === 'Результат обработки появится здесь' || resultText === 'Ошибка обработки') {
                showError('Нет результата для скачивания');
                return;
            }

            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcript.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyResult() {
            const resultText = document.getElementById('result-content').textContent;
            navigator.clipboard.writeText(resultText).then(() => {
                const copyBtn = document.getElementById('copy-btn');
                const copyBtnText = document.getElementById('copy-btn-text');

                copyBtn.classList.add('success');
                copyBtnText.textContent = 'Скопировано!';

                setTimeout(() => {
                    copyBtn.classList.remove('success');
                    copyBtnText.textContent = 'Копировать';
                }, 2000);
            }).catch(err => {
                showError('Не удалось скопировать текст');
                console.error('Copy failed:', err);
            });
        }

        // Drag and drop для файлов
        const fileLabel = document.getElementById('file-label');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileLabel.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileLabel.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileLabel.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            fileLabel.classList.add('highlight');
        }

        function unhighlight(e) {
            fileLabel.classList.remove('highlight');
        }

        fileLabel.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length) {
                document.getElementById('file-input').files = files;
                const event = new Event('change', { bubbles: true });
                document.getElementById('file-input').dispatchEvent(event);
            }
        }

        // --- Логика модального окна ---
        document.addEventListener('DOMContentLoaded', function() {
            const helpBtn = document.getElementById('help-btn');
            const modal = document.getElementById('help-modal');
            const closeModalBtn = document.querySelector('.modal-close');

            function openModal() {
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            }

            function closeModal() {
                modal.style.opacity = '0';
                modal.querySelector('.modal-content').style.transform = 'scale(0.9)';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }

            if (helpBtn && modal && closeModalBtn) {
                helpBtn.addEventListener('click', openModal);
                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }
        });

    </script>

    <div id="help-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Как это работает?</h2>
            <ol class="instruction-list">
                <li>
                    <strong>Шаг 1: Откройте код страницы</strong>
                    <p>Перейдите на страницу встречи в tl;dv, расшифровку которой нужно получить. Нажмите правой кнопкой мыши на тексте и выберите "Просмотреть код" (Inspect).</p>
                    <img src="/static/images/step1.png" alt="Инструкция, шаг 1">
                </li>
                <li>
                    <strong>Шаг 2: Найдите нужный элемент</strong>
                    <p>В открывшейся панели инструментов разработчика найдите и выделите HTML-элемент с тегом &lt;div id="transcript-container"&gt;. Это контейнер всей расшифровки.</p>
                    <img src="/static/images/step2.png" alt="Инструкция, шаг 2">
                    <p>Или просто зайдите в код страницы и с помощью поиска ctrl+F найдете тот же контейнер transcript-container</p>
                    <img src="/static/images/step3.png" alt="Инструкция, шаг 2-альтернатива">
                </li>
                <li>
                    <strong>Шаг 3: Скопируйте и сохраните код</strong>
                    <p>Нажмите на найденный элемент правой кнопкой мыши и выберите Копировать -> Копировать элемент (Copy -> Copy element). Вставьте скопированный HTML-код в простой текстовый редактор (Блокнот, TextEdit) и сохраните файл с любым именем, например, расшифровка.txt.</p>
                </li>
                <li>
                    <strong>Шаг 4: Загрузите файл и получите результат</strong>
                    <p><strong>Вариант 1:</strong> Вернитесь в это приложение и загрузите созданный вами файл.</p>
                    <p><strong>Вариант 2:</strong> Просто вставьте скопированный элемент кода в поле вставки в приложении.</p>
                    <p>Нажмите кнопку "Обработать". Скопируйте полученный чистый текст и используйте его по своему усмотрению (например, для создания краткого содержания в нейросети).</p>
                </li>
            </ol>
        </div>
    </div>

</body>
</html>